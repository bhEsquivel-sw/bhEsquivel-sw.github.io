<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>SW-PWA-DEV</title>
    <meta name="viewport" content="minimal-ui, width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    <meta name="theme-color" content="#9E9E9E">
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="favicon.ico" />
     <!-- iPhone, retina -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="apple-touch-icon" href="meta/2048-logo-80x80.png">
    <link rel="apple-touch-icon" sizes="152x152" href="meta/2048-logo-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="meta/2048-logo-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="meta/2048-logo-167x167.png">

    <meta name="application-name" content="SWPWA" />
    <meta name="msapplication-square70x70logo" content="meta/2048-logo-70x70.png" />
    <meta name="msapplication-square150x150logo" content="meta/2048-logo-152x152.png" />
    <meta name="msapplication-wide310x150logo" content="meta/2048-logo-310x150.png" />
    <meta name="msapplication-square310x310logo" content="meta/2048-logo-310x310.png" />
    <meta name="msapplication-TileColor" content="#ECC400" />

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
  <link rel="shortcut icon" href="favicon.ico"></head>
  <body>
    <button id="btnInstall" disabled display="none" style="position: absolute; top: 23px; right: 16px; z-index: 1;">Install Game1</button>
    <div>asd</div>
  <script type="text/javascript" src="main.bundle.js"></script></body> 
</html>
<script type="module" >
  import {Workbox} from 'https://storage.googleapis.com/workbox-cdn/releases/4.3.1/workbox-window.prod.mjs';

  // Check that service workers are supported
  if ('serviceWorker' in navigator) {
    /*// Use the window load event to keep the page load performant
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
      .then( function ( registration ) { // Registration was successful
          console.log( "ServiceWorker registration successful with scope: ", registration.scope );
      }).catch( function ( err ) { // registration failed :(
        console.error( "ServiceWorker registration failed: ", err );
      });
    });*/

    const wb = new Workbox('/service-worker.js');

    // Add an event listener to detect when the registered
    // service worker has installed but is waiting to activate.
    wb.addEventListener('waiting', (event) => {
      // `event.wasWaitingBeforeRegister` will be false if this is
      // the first time the updated service worker is waiting.
      // When `event.wasWaitingBeforeRegister` is true, a previously
      // updated same service worker is still waiting.
      // You may want to customize the UI prompt accordingly.

      // Assumes your app has some sort of prompt UI element
      // that a user can either accept or reject.
      const prompt = createUIPrompt({
        onAccept: async () => {
          // Assuming the user accepted the update, set up a listener
          // that will reload the page as soon as the previously waiting
          // service worker has taken control.
          wb.addEventListener('controlling', (event) => {
            window.location.reload();
          });

          // Send a message telling the service worker to skip waiting.
          // This will trigger the `controlling` event handler above.
          // Note: for this to work, you have to add a message
          // listener in your service worker. See below.
          wb.messageSW({type: 'SKIP_WAITING'});
        },

        onReject: () => {
          prompt.dismiss();
        }
      })
    });

    wb.register()
    .then( function ( registration ) { // Registration was successful
          console.log( "ServiceWorker registration successful with scope: ", registration.scope );
    }).catch( function ( err ) { // registration failed :(
        console.error( "ServiceWorker registration failed: ", err );
    });;
  }
  </script>
  

<script>
  let deferredPrompt;
  btnInstall = document.querySelector('#btnInstall')

  window.addEventListener('beforeinstallprompt', function(event) {
    console.log('beforeinstallprompt event was fired');
    btnInstall.style.display = 'display';
    // Prevent Chrome 67 and earlier from automatically showing the prompt
    event.preventDefault();
    // Stash the event so it can be triggered later.
    deferredPrompt = event;

    btnInstall.disabled = false;
  });

  // Installation must be done by a user gesture! Here, the button click
  btnInstall.addEventListener('click', (e) => {
    // hide our user interface that shows our A2HS button
    btnInstall.style.display = 'none';
    // Show the prompt
    deferredPrompt.prompt();
    // Wait for the user to respond to the prompt
    deferredPrompt.userChoice
      .then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the A2HS prompt');
        } else {
          console.log('User dismissed the A2HS prompt');
        }
        deferredPrompt = null;
      });
  });

  </script>

<script>

  if ('BroadcastChannel' in self) {
    const updateChannel = new BroadcastChannel('app-shell');

    updateChannel.addEventListener('message', event => {
      if (confirm(`New Version is available! OK to refresh`)) {
          window.location.reload();
        }
    });
  }
      
  </script>
